{% extends "layout.njk" %}

{% block title %}{{ title }} - Kainos{% endblock %}

{% block content %}
<script src="/js/job-filters.js"></script>

<div class="w-full max-w-7xl mx-auto">
  <!-- Page Header with DaisyUI -->
  <div class="flex flex-col lg:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex-1 text-center lg:text-left">
      <h1 class="text-5xl font-bold kainos-text-gradient">{{ title }}</h1>
      <p class="text-lg text-base-content/70 mt-2">Discover exciting career opportunities at Kainos</p>
    </div>
    {% if user and user.role === 'admin' %}
    <div class="flex flex-col sm:flex-row gap-2">
      <a href="/jobs/new" class="btn-kainos shadow-lg hover:shadow-xl inline-flex items-center gap-2">
        {{ icon('plus', 'h-5 w-5') | safe }}
        Add New Job Role
      </a>
      <a href="/jobs/report" class="btn-kainos-outline shadow-lg hover:shadow-xl inline-flex items-center gap-2">
        {{ icon('download', 'h-5 w-5') | safe }}
        Report
      </a>
    </div>
    {% endif %}
  </div>

  <!-- Filter Panel with DaisyUI Card -->
  <div class="card bg-base-100 shadow-xl mb-8">
    <div class="card-body">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
        <div>
          <h2 class="card-title text-3xl text-kainos-primary">Filter Job Roles</h2>
          <p class="text-base-content/70">Refine your search to find the perfect opportunity (filters apply automatically)</p>
        </div>
        <button onclick="_clearFilters()" class="btn-kainos-outline shadow-lg hover:shadow-xl inline-flex items-center gap-2">
          {{ icon('x', 'w-5 h-5') | safe }}
          Clear All
        </button>
      </div>

      <div class="divider"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Name Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Job Name</span>
          </label>
          <label class="input input-bordered flex items-center gap-2">
            {{ icon('search', 'h-4 w-4 opacity-70') | safe }}
            <input 
              type="text" 
              id="nameFilter" 
              placeholder="Search by job name..." 
              value="{{ currentFilters.name or '' }}"
              class="grow"
            />
          </label>
        </div>

        <!-- Location Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Location</span>
          </label>
          <select id="locationFilter" class="select select-bordered w-full">
            <option value="">All Locations</option>
            {% for loc in distinctValues.locations %}
            <option value="{{ loc }}" {% if currentFilters.location and (currentFilters.location.includes(loc)) %}selected{% endif %}>
              {{ loc }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Capability Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Capability</span>
          </label>
          <select id="capabilityFilter" class="select select-bordered w-full">
            <option value="">All Capabilities</option>
            {% for cap in distinctValues.capabilities %}
            <option value="{{ cap }}" {% if currentFilters.capability and (currentFilters.capability.includes(cap)) %}selected{% endif %}>
              {{ cap }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Band Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Band</span>
          </label>
          <select id="bandFilter" class="select select-bordered w-full">
            <option value="">All Bands</option>
            {% for b in distinctValues.bands %}
            <option value="{{ b }}" {% if currentFilters.band and (currentFilters.band.includes(b)) %}selected{% endif %}>
              {{ b }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="divider">Sort Options</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Sort By Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Sort By</span>
          </label>
          <select id="sortByFilter" class="select select-bordered w-full">
            <option value="">No Sorting</option>
            <option value="name" {% if currentSort.sortBy == 'name' %}selected{% endif %}>Job Name</option>
            <option value="location" {% if currentSort.sortBy == 'location' %}selected{% endif %}>Location</option>
            <option value="capability" {% if currentSort.sortBy == 'capability' %}selected{% endif %}>Capability</option>
            <option value="band" {% if currentSort.sortBy == 'band' %}selected{% endif %}>Band</option>
          </select>
        </div>

        <!-- Sort Order Filter -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Sort Order</span>
          </label>
          <select id="sortOrderFilter" class="select select-bordered w-full">
            <option value="asc" {% if currentSort.sortOrder == 'asc' %}selected{% endif %}>Ascending (A-Z)</option>
            <option value="desc" {% if currentSort.sortOrder == 'desc' %}selected{% endif %}>Descending (Z-A)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Count with Stats -->
  <div class="stats shadow mb-6 w-full bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        {{ icon('clipboard-list', 'h-8 w-8') | safe }}
      </div>
      <div class="stat-title">Available Positions</div>
      <div class="stat-value text-primary">{{ pagination.totalResults }}</div>
      <div class="stat-desc">Showing {{ jobRoles.length }} of {{ pagination.totalResults }} results (Page {{ pagination.currentPage }} of {{ pagination.totalPages }})</div>
    </div>
  </div>

  {% if jobRoles.length > 0 %}
    <!-- Table with DaisyUI -->
    <div class="card bg-base-100 shadow-xl">
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Job Name</th>
              <th>Location</th>
              <th>Capability</th>
              <th>Band</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for job in jobRoles %}
            <tr class="hover">
              <td class="font-medium">{{ job.name }}</td>
              <td>{{ job.location }}</td>
              <td>{{ job.capability }}</td>
              <td>{{ job.band }}</td>
              <td>
                <a href="/jobs/{{ job.id }}/details" class="btn-kainos shadow-md hover:shadow-lg inline-flex items-center gap-2 text-sm px-4 py-2">
                  <span>View Details</span>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination Controls -->
    {% if pagination.totalPages > 1 %}
    <div class="flex justify-center items-center gap-4 mt-6">
      <div class="join">
        {% if pagination.hasPrevPage %}
        <a href="?page={{ pagination.currentPage - 1 }}&limit={{ pagination.limit }}{% if currentFilters.name %}&name={{ currentFilters.name }}{% endif %}{% for loc in currentFilters.location %}&location={{ loc }}{% endfor %}{% for cap in currentFilters.capability %}&capability={{ cap }}{% endfor %}{% for b in currentFilters.band %}&band={{ b }}{% endfor %}{% if currentSort.sortBy %}&sortBy={{ currentSort.sortBy }}&sortOrder={{ currentSort.sortOrder }}{% endif %}" 
           class="join-item btn btn-outline">
          {{ icon('chevron-left', 'h-5 w-5') | safe }}
          Previous
        </a>
        {% else %}
        <button class="join-item btn btn-outline btn-disabled" disabled>
          {{ icon('chevron-left', 'h-5 w-5') | safe }}
          Previous
        </button>
        {% endif %}

        <button class="join-item btn btn-outline no-animation">
          Page {{ pagination.currentPage }} of {{ pagination.totalPages }}
        </button>

        {% if pagination.hasNextPage %}
        <a href="?page={{ pagination.currentPage + 1 }}&limit={{ pagination.limit }}{% if currentFilters.name %}&name={{ currentFilters.name }}{% endif %}{% for loc in currentFilters.location %}&location={{ loc }}{% endfor %}{% for cap in currentFilters.capability %}&capability={{ cap }}{% endfor %}{% for b in currentFilters.band %}&band={{ b }}{% endfor %}{% if currentSort.sortBy %}&sortBy={{ currentSort.sortBy }}&sortOrder={{ currentSort.sortOrder }}{% endif %}" 
           class="join-item btn btn-outline">
          Next
          {{ icon('chevron-right', 'h-5 w-5') | safe }}
        </a>
        {% else %}
        <button class="join-item btn btn-outline btn-disabled" disabled>
          Next
          {{ icon('chevron-right', 'h-5 w-5') | safe }}
        </button>
        {% endif %}
      </div>
    </div>
    {% endif %}
  {% else %}
    <div role="alert" class="alert alert-info">
      {{ icon('info', 'stroke-current shrink-0 w-6 h-6') | safe }}
      <span>No job roles found matching your criteria.</span>
    </div>
  {% endif %}

  <!-- Back Button -->
  <div class="mt-8 flex justify-center">
    <a href="/" class="btn btn-outline btn-primary gap-2">
      {{ icon('arrow-left', 'h-5 w-5') | safe }}
      Back to Home
    </a>
  </div>
</div>
{% endblock %}