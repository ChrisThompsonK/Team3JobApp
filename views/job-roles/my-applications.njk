{% extends "layout.njk" %}

{% block title %}My Applications - Kainos Careers{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
  <!-- Page Header -->
  <div class="text-center mb-8">
    <h1 class="text-5xl md:text-6xl font-bold kainos-text-gradient mb-4">My Job Applications</h1>
    <p class="text-lg text-base-content/70">Track your application status and manage your career journey with Kainos</p>
  </div>

  {% if applications and applications.length > 0 %}
    <!-- Applications List -->
    <div class="grid gap-6">
      {% for app in applications %}
      <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow border-l-4 {% if app.applicationStatus == 'Hired' %}border-kainos-green{% elif app.applicationStatus == 'Rejected' %}border-red-500{% elif app.applicationStatus == 'Withdrawn' %}border-red-500{% else %}border-kainos-primary{% endif %}">
        <div class="card-body">
          <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <!-- Job Info -->
            <div class="flex-1">
              <h2 class="card-title text-2xl mb-2">
                <a href="/jobs/{{ app.jobRoleId }}/details" class="text-kainos-primary hover:text-kainos-green transition-colors">
                  {{ app.roleName }}
                </a>
              </h2>
              
              <div class="flex flex-wrap gap-4 text-sm text-base-content/70 mb-3">
                <div class="flex items-center gap-2">
                  {{ icon('map-pin', 'h-4 w-4') | safe }}
                  <span>{{ app.location }}</span>
                </div>
                
                <div class="flex items-center gap-2">
                  {{ icon('lightbulb', 'h-4 w-4') | safe }}
                  <span>{{ app.capability }}</span>
                </div>
                
                <div class="flex items-center gap-2">
                  {{ icon('trending-up', 'h-4 w-4') | safe }}
                  <span>{{ app.band }}</span>
                </div>
              </div>

              <div class="text-sm text-base-content/60">
                <div class="flex items-center gap-2">
                  {{ icon('calendar', 'h-4 w-4') | safe }}
                  <span>Applied: {{ app.appliedDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) }}</span>
                </div>
              </div>
            </div>

            <!-- Status Badge and Actions -->
            <div class="flex flex-col items-end gap-3">
              <!-- Status Badge -->
              <div class="badge badge-lg px-4 py-3 font-semibold
                {% if app.applicationStatus == 'Hired' %}
                  bg-kainos-green text-white border-kainos-green
                {% elif app.applicationStatus == 'Rejected' %}
                  bg-red-500 text-white border-red-500
                {% elif app.applicationStatus == 'Withdrawn' %}
                  bg-red-500 text-white border-red-500
                {% elif app.applicationStatus == 'Under Review' %}
                  bg-yellow-500 text-white border-yellow-500
                {% else %}
                  bg-kainos-primary text-white border-kainos-primary
                {% endif %}">
                {{ app.applicationStatus }}
              </div>

              <!-- Application ID -->
              {% if app.id %}
              <div class="text-xs text-base-content/50">
                App ID: {{ app.id }}
              </div>
              {% endif %}

              <!-- Action Buttons -->
              <div class="flex flex-col gap-2">
                <!-- View Job Details Button -->
                <a href="/jobs/{{ app.jobRoleId }}/details" class="btn-kainos-outline shadow-md hover:shadow-lg inline-flex items-center gap-2 text-sm px-4 py-2">
                  {{ icon('eye', 'h-4 w-4') | safe }}
                  <span>View Job</span>
                </a>

                <!-- Withdraw Application Button - Only show for applications that can be withdrawn -->
                {% if app.applicationStatus == 'In Progress' or app.applicationStatus == 'Under Review' %}
                <form method="POST" action="/applications/{{ app.id }}/withdraw" style="display: inline;" id="withdraw-form-{{ app.id }}">
                  <button 
                    type="button"
                    data-role-name="{{ app.roleName | escape }}"
                    onclick="confirmWithdraw('{{ app.id }}', this.getAttribute('data-role-name'))"
                    class="btn btn-error text-white shadow-md hover:shadow-lg inline-flex items-center gap-2 text-sm px-4 py-2"
                  >
                    {{ icon('x-circle', 'h-4 w-4') | safe }}
                    <span>Withdraw</span>
                  </button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Summary Stats -->
    <div class="stats stats-vertical lg:stats-horizontal shadow mt-8 w-full bg-kainos-light">
      <div class="stat">
        <div class="stat-figure text-kainos-primary">
          {{ icon('file-text', 'h-8 w-8') | safe }}
        </div>
        <div class="stat-title text-kainos-dark">Total Applications</div>
        <div class="stat-value text-kainos-primary">{{ applications.length }}</div>
      </div>
    </div>

  {% else %}
    <!-- No Applications -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body text-center py-16">
        <div class="flex justify-center mb-6">
          {{ icon('file-text', 'h-24 w-24 text-base-content/30') | safe }}
        </div>
        <h2 class="text-3xl font-bold text-kainos-primary mb-4">No Applications Yet</h2>
        <p class="text-lg text-base-content/70 mb-8">You haven't applied to any positions yet. Start exploring our open roles!</p>
        <div class="flex justify-center gap-4">
          <a href="/jobs" class="btn-kainos shadow-lg hover:shadow-xl inline-flex items-center gap-2">
            {{ icon('search', 'h-5 w-5') | safe }}
            <span>Browse Jobs</span>
          </a>
          <a href="/" class="btn-kainos-outline shadow-lg hover:shadow-xl inline-flex items-center gap-2">
            {{ icon('home', 'h-5 w-5') | safe }}
            <span>Go Home</span>
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Back to Home -->
  <div class="mt-8 flex justify-center">
    <a href="/" class="btn-kainos-outline shadow-md hover:shadow-lg inline-flex items-center gap-2">
      {{ icon('arrow-left', 'h-5 w-5') | safe }}
      <span>Back to Home</span>
    </a>
  </div>
</div>

<script>
  // Confirm withdrawal with a single dialog
  function confirmWithdraw(appId, roleName) {
    // Show confirmation dialog only once
    const confirmed = confirm(`Are you sure you want to withdraw your application for ${roleName}? This action cannot be undone.`);
    
    if (confirmed) {
      // Submit the form
      const form = document.getElementById('withdraw-form-' + appId);
      if (form) {
        form.submit();
      }
    }
  }

  // Show success message if redirected after withdrawal
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('withdrawn') === 'true') {
    // Create a temporary success alert
    const alert = document.createElement('div');
    alert.className = 'alert alert-success fixed top-4 right-4 w-auto z-50 shadow-lg';
    alert.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>Application withdrawn successfully</span>
    `;
    document.body.appendChild(alert);
    
    // Remove the alert after 5 seconds
    setTimeout(() => {
      alert.remove();
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }, 5000);
  }
</script>

{% endblock %}
